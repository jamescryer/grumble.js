/* (c) 2011 James Cryer, Huddle (www.huddle.com)  http://jamescryer.github.com/grumble.js/ */
(function(i){var j=i.jQuery,a={type:"",text:"",top:0,left:0,angle:45,size:50,distance:50,template:'<div class="grumble" style="display:none;filter:progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\')">&#160;</div>',textTemplate:'<div class="grumble-text" style="display:none;"><div class="outer"><div class="inner">{text}</div></div></div>'};i.GrumbleBubble=function(b){this.options=j.extend({},a,b);this.context=document.body;this.css={};this.create()};i.GrumbleBubble.prototype={create:function(){var b=
i.GrumbleBubble.prototype.tmpl;this.bubble=j(b(this.options.template));this.text=j(b(this.options.textTemplate,{text:this.options.text}));this.prepare()},setBubbleRotation:function(){this.rotateDeg=this.options.angle-45;0>this.rotateDeg&&(this.rotateDeg+=360)},prepare:function(){var b=this.bubble.get(0).parentNode;this.setBubbleRotation();this.applyStyles();b!==this.context&&this.append();this.rotate()},applyStyles:function(){this.setPosition();this.css.width=this.options.size;this.css.height=this.options.size;
this.text.css(this.css).addClass("grumble-text"+this.options.size);this.bubble.css(this.css).addClass(this.options.type+"grumble"+this.options.size);this.realLeft=this.css.left;this.realTop=this.css.top},setPosition:function(){var b=this.options.angle/-360,a=Math.cos(2*b*Math.PI),h=Math.sin(2*b*Math.PI),b=this.options.size/2,c=this.options.size*this.options.size,c=Math.sqrt(c+c)/2,h=this.options.left-b-h*(this.options.distance+c);this.css.top=this.options.top+b-a*(this.options.distance+c)-this.options.size;
this.css.left=h},append:function(){var b=this.context;this.bubble.appendTo(b);this.text.appendTo(b)},rotate:function(){!0===j.browser.msie?this.ieRotate():this.cssRotate()},cssRotate:function(){this.bubble.css({"-moz-transform":"rotate("+this.rotateDeg+"deg)","-webkit-transform":"rotate("+this.rotateDeg+"deg)","-o-transform":"rotate("+this.rotateDeg+"deg)",transform:"rotate("+this.rotateDeg+"deg)"})},ieRotate:function(){var b=this.rotateDeg*(2*Math.PI/360),a=Math.cos(b),b=Math.sin(b),h=this.bubble.get(0);
h.filters.item(0).M11=a;h.filters.item(0).M12=-b;h.filters.item(0).M21=b;h.filters.item(0).M22=a;a=this.bubble.width();b=this.bubble.height();this.bubble.css({left:this.css.left-(a-this.options.size)/2,top:this.css.top-(b-this.options.size)/2})},adjust:function(b){j.extend(this.options,b);this.prepare()},tmpl:function(b,a,h){for(var c in a)null===a[c]&&(a[c]=""),"object"===typeof a[c]&&a[c].length&&(a[c]=a[c].join(", ")),b=b.replace(RegExp("{"+c+"}","g"),h?escape(a[c]):a[c]);return b}}})(window);(function(i){function j(b,c,m){var e=a('<div style="position:absolute;visibility:hidden;width:'+b+'px;">'+m+"</div>").appendTo(a(document.body)),i=2*e.outerHeight()+0.2*b,k=a.inArray(b,c);e.remove();return i>=b&&c[++k]?j(c[k],c,m):b}var a=i.jQuery,b=i.GrumbleBubble,l=[];a.fn.grumble=function(h,c){return"string"===typeof h?(this.trigger({type:h+".bubble",adjustments:c}),this):this.each(function(){var c=a(this),e=a.extend({},a.fn.grumble.defaults,h,c.data("grumble")||{}),n=c.offset(),k=j(e.size,e.sizeRange,
e.text),d,f,g;if(a.data(this,"hazGrumble"))return c.grumble("adjust",h),c.grumble("show"),!0;a.data(this,"hazGrumble",!0);e.top=n.top+c.height();e.left=n.left+c.width()/2;g={init:function(){d=new b({text:e.text,top:e.top,left:e.left,angle:e.angle,size:k,distance:e.distance,type:e.type});e.hasHideButton&&this.addButton();l.push({grumble:d,button:f,onHide:function(){g.isVisible=!1;a(document.body).unbind("click.bubble");g.doOnBeginHideCallback();g.doOnHideCallback()}});this.showBubble();this.prepareEvents()},
addButton:function(){var c=b.prototype.tmpl;f=a(c(e.buttonTemplate,{hideText:e.buttonHideText})).css({left:d.realLeft+k-10,top:d.realTop+k-10}).insertAfter(d.text)},rePositionButton:function(){f&&f.css({left:d.realLeft+k-10,top:d.realTop+k-10})},createFxQueue:function(){d.bubble.queue("fx");d.text.queue("fx");d.bubble.delay(e.showAfter);d.text.delay(e.showAfter);f&&f.delay(e.showAfter)},showBubble:function(){!0!=g.isVisible&&(e.showAfter&&g.createFxQueue(),!0===a.browser.msie?(d.bubble.queue("fx",
function(a){d.bubble.show();a()}),d.text.queue("fx",function(a){d.text.show();a()}),f&&f.queue("fx",function(a){f.show();a()})):(d.bubble.fadeTo("fast",1),d.text.fadeTo("fast",1),f&&f.fadeTo("fast",1)),d.bubble.queue("fx",function(a){g.isVisible=!0;(e.hideOnClick||e.hasHideButton)&&g.hideOnClick();g.doOnShowCallback();a()}),e.hideAfter&&g.hideBubble())},hideBubble:function(){d.bubble.delay(e.hideAfter);d.text.delay(e.hideAfter);d.bubble.queue("fx",function(a){g.doOnBeginHideCallback();a()});!0===
a.browser.msie?(d.bubble.queue("fx",function(a){d.bubble.hide();a()}),d.bubble.queue("fx",function(a){d.text.hide();a()}),f&&f.queue("fx",function(a){f.hide();a()})):(d.bubble.fadeOut(),d.text.fadeOut(),f&&f.fadeOut());d.bubble.queue("fx",function(a){g.isVisible=!1;g.doOnHideCallback();a()})},doOnBeginHideCallback:function(){e.onBeginHide(d,f)},doOnHideCallback:function(){e.onHide(d,f)},doOnShowCallback:function(){e.onShow(d,f)},hideOnClick:function(){setTimeout(function(){var b=function(){g.hideBubble(d,
f);a(document.body).unbind("click.bubble",b)};a(document.body).bind("click.bubble",b)},1E3)},prepareEvents:function(){a(i).bind("resize.bubble",function(){var a=c.offset(),b=a.top+c.height(),a=a.left+c.width()/2;d.adjust({top:b,left:a});g.rePositionButton()});c.bind("hide.bubble",function(){g.hideBubble(d,f)});c.bind("adjust.bubble",function(a){a.adjustments&&"object"===typeof a.adjustments&&d.adjust(a.adjustments)});c.bind("show.bubble",function(){g.showBubble(d,f)})}};g.init()})};a.fn.grumble.defaults=
{text:"",angle:45,size:50,sizeRange:[50,100,150,200],distance:0,type:"",showAfter:0,hideAfter:!1,hideOnClick:!1,hasHideButton:!1,buttonTemplate:'<div class="grumble-button" style="display:none" title="{hideText}">x</div>',buttonHideText:"Hide",onHide:function(){},onShow:function(){},onBeginHide:function(){}};a(document).bind("keyup.bubble",function(b){27===b.keyCode&&a.each(l,function(a,b){b.grumble.bubble.clearQueue().hide();b.grumble.text.clearQueue().hide();b.button&&b.button.clearQueue().hide();
b.onHide()})})})(window);
